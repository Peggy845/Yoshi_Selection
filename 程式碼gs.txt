function doGet(e) {
  const ss = SpreadsheetApp.openById('1KXmggPfKqpg5gZCsUujlpdTcKSFdGJHv4bOux3nc2xo');
  const action = e.parameter.action || '';
  const type = e.parameter.type || 'category';

  // 取得分頁名稱（排除 "分類圖片"）
  if (action === 'getSheetNames') {
    const sheets = ss.getSheets();
    const sheetNames = sheets.map(s => s.getName()).filter(name => name !== '分類圖片');
    return ContentService
      .createTextOutput(JSON.stringify(sheetNames))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // 取得分類圖片
  if (type === 'category') {
    const sheet = ss.getSheetByName('分類圖片');
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ error: '找不到分類圖片分頁' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    const data = sheet.getDataRange().getValues();
    const categoryImages = [];
    for (let i = 1; i < data.length; i++) {
      categoryImages.push({
        mainCat: data[i][0],
        mainImg: data[i][1],
        subCat: data[i][2],
        subImg: data[i][3]
      });
    }
    return ContentService.createTextOutput(JSON.stringify({ categoryImages }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // 取得商品（後端直接過濾）
  if (type === 'product') {
    const sheetName = e.parameter.sheet;
    const subCategory = e.parameter.subCategory || ''; // 第二層分類名稱

    if (!sheetName) {
      return ContentService.createTextOutput(JSON.stringify({ error: '缺少 sheet 參數' }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ error: '找不到分頁: ' + sheetName }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const products = [];

    for (let i = 1; i < data.length; i++) {
      let product = {};
      for (let j = 0; j < headers.length; j++) {
        product[headers[j]] = data[i][j];
      }

      // 後端直接過濾「商品系列」欄位
      if (!subCategory || String(product['商品系列']).trim() === String(subCategory).trim()) {
        products.push(product);
      }
    }

    return ContentService.createTextOutput(JSON.stringify({ products }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({ error: '無效的 action 參數' }))
    .setMimeType(ContentService.MimeType.JSON);
}
