function doGet(e) {
  var category = e.parameter.category || '';
  var subcategory = e.parameter.subcategory || '';
  var sheetNames = SpreadsheetApp.getActiveSpreadsheet().getSheets().map(s => s.getName());

  var allData = [];

  sheetNames.forEach(function(sheetName) {
    if (sheetName === '分類圖片') return; // 跳過分類圖片分頁
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    var data = sheet.getDataRange().getValues();
    var headers = data.shift();

    data.forEach(function(row) {
      var item = {};
      headers.forEach(function(h, i) {
        item[h] = row[i];
      });

      // 過濾條件
      if ((category && item['主分類'] !== category) || 
          (subcategory && item['子分類'] !== subcategory)) {
        return;
      }
      
      allData.push(item);
    });
  });

  return ContentService
    .createTextOutput(JSON.stringify(allData))
    .setMimeType(ContentService.MimeType.JSON);
}
