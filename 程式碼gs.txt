function doGet(e) {
  const ss = SpreadsheetApp.openById("1KXmggPfKqpg5gZCsUujlpdTcKSFdGJHv4bOux3nc2xo");
  const sheet = ss.getSheetByName("分類圖片");

  if (e.parameter.type === "categories") {
    const values = sheet.getDataRange().getValues();
    const headers = values.shift();
    const mainCatIndex = headers.indexOf("頂層分類");
    const mainImgIndex = headers.indexOf("頂層分類圖片檔名");
    const subCatIndex = headers.indexOf("第二層分類");
    const subImgIndex = headers.indexOf("第二層分類圖片檔名");

    const cats = {};
    values.forEach(row => {
      const main = row[mainCatIndex];
      const mainImg = getDriveImageUrl(row[mainImgIndex]);
      const sub = row[subCatIndex];
      const subImg = getDriveImageUrl(row[subImgIndex]);

      if (!cats[main]) {
        cats[main] = { mainCat: main, mainImage: mainImg, subCategories: [] };
      }
      cats[main].subCategories.push({ subCat: sub, subImage: subImg });
    });

    return ContentService.createTextOutput(JSON.stringify(Object.values(cats))).setMimeType(ContentService.MimeType.JSON);
  }

  if (e.parameter.type === "products") {
    const mainCat = e.parameter.main;
    const subCat = e.parameter.sub;
    const productSheet = ss.getSheetByName(mainCat);
    if (!productSheet) {
      return ContentService.createTextOutput("[]").setMimeType(ContentService.MimeType.JSON);
    }

    const data = productSheet.getDataRange().getValues();
    const headers = data.shift();
    const nameIndex = headers.indexOf("商品名稱");
    const priceIndex = headers.indexOf("價格");
    const imageIndex = headers.indexOf("商品圖片");
    const categoryIndex = headers.indexOf("商品系列");

    const products = data
      .filter(row => !subCat || row[categoryIndex] === subCat)
      .map(row => ({
        name: row[nameIndex],
        price: row[priceIndex],
        image: getDriveImageUrl(row[imageIndex])
      }));

    return ContentService.createTextOutput(JSON.stringify(products)).setMimeType(ContentService.MimeType.JSON);
  }
}

function getDriveImageUrl(filename) {
  const files = DriveApp.getFilesByName(filename);
  if (files.hasNext()) {
    return `https://drive.google.com/uc?id=${files.next().getId()}`;
  }
  return "";
}
