/**
 * doGet()
 * 支援兩種模式：
 * 1. ?type=category → 讀取「分類圖片」分頁
 * 2. ?type=product&sheet=分頁名稱 → 讀取該分頁的商品資料
 */
function doGet(e) {
  const ss = SpreadsheetApp.openById('1KXmggPfKqpg5gZCsUujlpdTcKSFdGJHv4bOux3nc2xo');

  const type = e && e.parameter && e.parameter.type ? e.parameter.type : 'category';

  if (type === 'category') {
    // 讀取分類圖片
    const sheet = ss.getSheetByName('分類圖片');
    const data = sheet.getDataRange().getValues();
    const categoryImages = [];

    for (let i = 1; i < data.length; i++) {
      categoryImages.push({
        mainCat: data[i][0],
        mainImg: data[i][1],
        subCat: data[i][2],
        subImg: data[i][3]
      });
    }

    return ContentService.createTextOutput(
      JSON.stringify({ categoryImages })
    ).setMimeType(ContentService.MimeType.JSON);

  } else if (type === 'product') {
    // 確認有提供 sheet 參數
    if (!e.parameter.sheet) {
      return ContentService.createTextOutput(
        JSON.stringify({ error: '缺少 sheet 參數' })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    const sheetName = e.parameter.sheet;
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      return ContentService.createTextOutput(
        JSON.stringify({ error: '找不到分頁: ' + sheetName })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const products = [];

    for (let i = 1; i < data.length; i++) {
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = data[i][idx];
      });
      products.push(row);
    }

    return ContentService.createTextOutput(
      JSON.stringify({ products })
    ).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(
    JSON.stringify({ error: '未知的 type 參數' })
  ).setMimeType(ContentService.MimeType.JSON);
}
